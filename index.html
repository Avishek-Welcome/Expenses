<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ñ‡¶∞‡¶ö (PWA)</title>
    
    <meta name="theme-color" content="#E91E63"/>
    <link rel="apple-touch-icon" href="https://via.placeholder.com/192/E91E63/FFFFFF?text=‡¶ñ‡¶∞‡¶ö">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" id="manifest-data" href="data:application/json;base64,eyJpY29ucyI6IFt7ICJzaXplcyI6ICIxOTJ4MTkyIiwgInR5cGUiOiAiaW1hZ2UvcG5nIiwgInNyYyI6ICJodHRwczovL3ZpYS5wbGFjZWhvbGRlci5jb20vMTkyL0U5MUU2My9GRkZGRkY/dGV4dD0lRUIlODElQUMlRUIlODIlQUElRkUlOTAlOUQiIH0sIHsgInNpemVzIjogIjUxMng1MTIiLCAidHlwZSI6ICJpbWFnZS9wbmciLCAic3JjIjogImh0dHBzOi8vdmlhLnBsYWNlaG9sZGVyLmNvbS81MTIvRTkxRTYzL0ZGRkZGRj90ZXh0PSVFOEIlOUQlQTIlRTglOUQlQjElRUIlODElQUMlRUIlODIlQUElRkUlOTAlOUQiIH1dLCAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwgIm5hbWUiOiAi4KSa4KS44KSf4KSCIOCkuOCkguCknOCkvuCSleCkkyIsICJzaG9ydF9uYW1lIjogIuCSleCkkyIsICJzdGFydF91cmwiOiAiLi8iIH0=">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        /* Modern UI ‡¶è‡¶¨‡¶Ç ‡¶™‡¶ø‡¶ô‡ßç‡¶ï ‡¶•‡¶ø‡¶Æ CSS */
        :root {
            --primary-color: #E91E63; /* Deep Pink */
            --secondary-color: #FFC0CB; /* Light Pink */
            --light-bg: #F8F9FA; 
            --card-bg: #FFFFFF;
            --dark-text: #212529;
            --income-color: #2ECC71;
            --expense-color: #E74C3C;
            --category-color-1: #48DBFB;
            --category-color-2: #1DD1A1;
            --category-color-3: #FFC0CB;
            --category-color-4: #Feca57;
            --category-color-5: #FF6B6B;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--light-bg);
            color: var(--dark-text);
            margin: 0;
            padding: 20px 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            width: 100%;
            max-width: 600px;
            padding: 15px;
        }
        h1 {
            font-size: 1.8em;
            text-align: center;
            color: var(--primary-color);
            margin: 10px 0 20px;
            font-weight: 700;
        }
        h2 {
            font-size: 1.3em;
            color: var(--primary-color);
            margin-top: 25px;
            margin-bottom: 15px;
        }
        
        /* --- ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶ï‡¶æ‡¶∞‡ßç‡¶° --- */
        #total-balance {
            background: linear-gradient(135deg, var(--primary-color), #FF4081);
            color: white;
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 25px;
        }
        #total-balance div {
            font-size: 1.1em;
            opacity: 0.9;
        }
        #balance-amount {
            font-size: 2.5em;
            font-weight: 700;
            display: block;
            margin-top: 5px;
        }
        
        /* --- ‡¶´‡¶∞‡ßç‡¶Æ ‡¶ì ‡¶á‡¶®‡¶™‡ßÅ‡¶ü --- */
        #new-transaction-form {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        input:not([type="button"]), select {
            padding: 12px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            font-size: 16px;
            transition: border-color 0.2s;
        }
        input:focus {
            border-color: var(--primary-color);
            outline: none;
        }
        
        /* --- ‡¶∏‡ßç‡¶≤‡¶æ‡¶á‡¶°‡¶ø‡¶Ç ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø --- */
        #category-slider {
            white-space: nowrap;
            overflow-x: auto;
            padding-bottom: 10px; 
            margin-bottom: 5px;
            -webkit-overflow-scrolling: touch;
        }
        .category-tag {
            display: inline-block;
            padding: 8px 15px;
            margin-right: 10px;
            border: 2px solid var(--secondary-color);
            border-radius: 20px;
            background-color: var(--card-bg);
            color: var(--dark-text);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9em;
        }
        .category-tag.selected {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 2px 5px rgba(233, 30, 99, 0.4);
        }

        /* --- ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü‡¶∞ ‡¶ì ‡¶¨‡¶æ‡¶ü‡¶® --- */
        #calculator-display {
            background-color: #fff;
            border: 2px solid #dee2e6;
            padding: 15px;
            margin-bottom: 10px;
            text-align: right;
            font-size: 2em;
            font-weight: 600;
            border-radius: 8px;
        }
        #calculator-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .calc-btn {
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            cursor: pointer;
            background-color: #f1f3f5;
        }
        .op-btn { 
            background-color: var(--primary-color);
            color: white;
        }
        .eq-btn { 
            grid-column: span 2;
        }

        /* --- ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ì ‡¶ö‡¶æ‡¶∞‡ßç‡¶ü ‡¶∏‡ßá‡¶ï‡¶∂‡¶® --- */
        #filter-options {
            display: flex;
            justify-content: space-between;
            gap: 5px;
            margin-bottom: 10px;
        }
        #filter-options button {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--primary-color);
            border-radius: 6px;
            background-color: white;
            color: var(--primary-color);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9em;
        }
        #filter-options button.active {
            background-color: var(--primary-color);
            color: white;
        }
        #chart-container {
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-top: 20px;
        }

        /* --- ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ --- */
        #transaction-list {
            list-style: none;
            padding: 0;
        }
        #transaction-list li {
            position: relative;
            background-color: var(--card-bg);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            overflow: hidden; 
        }
        .transaction-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .transaction-category {
            font-size: 0.9em;
            color: #777;
        }
        .transaction-amount {
            font-size: 1.1em;
            font-weight: 600;
        }
        .expense .transaction-amount {
            color: var(--expense-color);
        }
        .income .transaction-amount {
            color: var(--income-color);
        }
        .transaction-description {
            font-size: 0.8em;
            color: #A0A0A0;
            margin-top: 2px;
        }

        /* --- ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶¨‡¶æ‡¶ü‡¶® (‡¶∏‡ßç‡¶≤‡¶æ‡¶á‡¶° ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®) --- */
        .delete-btn {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 70px;
            background-color: var(--expense-color);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: translateX(100%);
            transition: transform 0.3s ease-out;
            font-size: 1.2em;
        }
        .transaction-item-content {
            flex-grow: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding-right: 10px;
            transform: translateX(0);
            transition: transform 0.3s ease-out;
        }
        .li-swiped .transaction-item-content {
            transform: translateX(-70px);
        }
        .li-swiped .delete-btn {
            transform: translateX(0);
        }
        #export-btn {
            background-color: #6c757d;
            border-radius: 8px;
            color: white;
            padding: 12px;
            margin-top: 25px;
            font-size: 16px;
            width: 100%;
            border: none;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ñ‡¶∞‡¶ö üí∞</h1>

        <div id="total-balance">
            <div>‡¶Æ‡ßã‡¶ü ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</div>
            <span id="balance-amount">‡ß¶.‡ß¶‡ß¶</span> ‚Çπ
        </div>
        
        <form id="new-transaction-form">
            <h2>‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø</h2>
            <label for="date">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</label>
            <input type="date" id="date" required>

            <label>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®:</label>
            <div id="category-slider">
                </div>
            <input type="hidden" id="category" value="" required>

            <label for="description">‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï):</label>
            <input type="text" id="description" placeholder="‡¶ï‡ßÄ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ñ‡¶∞‡¶ö ‡¶ï‡¶∞‡¶≤‡ßá‡¶®? (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)">

            <label for="amount-display">‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡¶á‡¶®‡¶ï‡¶æ‡¶Æ ‡¶π‡¶≤‡ßá ‡¶™‡¶ú‡¶ø‡¶ü‡¶ø‡¶≠, ‡¶ñ‡¶∞‡¶ö ‡¶π‡¶≤‡ßá ‡¶®‡ßá‡¶ó‡ßá‡¶ü‡¶ø‡¶≠):</label>
            <div id="calculator-display">0</div>
            <input type="hidden" id="amount" value="0"> 

            <div id="calculator-buttons">
                <button type="button" class="calc-btn" data-value="7">7</button>
                <button type="button" class="calc-btn" data-value="8">8</button>
                <button type="button" class="calc-btn" data-value="9">9</button>
                <button type="button" class="calc-btn op-btn" data-value="C">C</button>
                
                <button type="button" class="calc-btn" data-value="4">4</button>
                <button type="button" class="calc-btn" data-value="5">5</button>
                <button type="button" class="calc-btn" data-value="6">6</button>
                <button type="button" class="calc-btn op-btn" data-value="+">+</button>

                <button type="button" class="calc-btn" data-value="1">1</button>
                <button type="button" class="calc-btn" data-value="2">2</button>
                <button type="button" class="calc-btn" data-value="3">3</button>
                <button type="button" class="calc-btn op-btn" data-value="-">-</button>

                <button type="button" class="calc-btn" data-value=".">.</button>
                <button type="button" class="calc-btn" data-value="0">0</button>
                <button type="button" class="calc-btn op-btn eq-btn" data-value="=">=</button>
            </div>

            <button type="submit" id="add-btn">‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </form>

        <h2>‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶ì ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£</h2>
        <div id="filter-options">
            <button id="filter-day" class="active" data-view="day">‡¶¶‡¶ø‡¶® ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ</button>
            <button id="filter-month" data-view="month">‡¶Æ‡¶æ‡¶∏ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ</button>
            <button id="filter-year" data-view="year">‡¶¨‡¶õ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ</button>
        </div>
        <input type="date" id="date-filter" style="margin-top: 10px;">

        <div id="chart-container">
            <h3>‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶¨‡ßç‡¶Ø‡¶Ø‡¶º‡ßá‡¶∞ ‡¶¨‡¶®‡ßç‡¶ü‡¶® (‡¶™‡¶æ‡¶á ‡¶ö‡¶æ‡¶∞‡ßç‡¶ü)</h3>
            <canvas id="expenseChart"></canvas>
            <p id="chart-message" style="text-align: center; color: #777; font-size: 0.9em;"></p>
        </div>

        <h2 style="margin-top: 30px;">‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h2>
        <ul id="transaction-list">
            </ul>
        
        <button id="export-btn">‡¶°‡ßá‡¶ü‡¶æ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)</button>
    </div>

    <script>
        // ‡¶ú‡¶æ‡¶≠‡¶æ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü ‡¶≤‡¶ú‡¶ø‡¶ï

        // --- PWA Service Worker ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const serviceWorkerContent = `
                    self.addEventListener('install', (event) => {
                        event.waitUntil(
                            caches.open('expense-manager-cache-v4').then((cache) => {
                                // Important: Cache all necessary assets including Chart.js CDN link
                                return cache.addAll(['./expense_manager_advanced_chart.html', 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js']);
                            })
                        );
                    });

                    self.addEventListener('fetch', (event) => {
                        event.respondWith(
                            caches.match(event.request).then((response) => {
                                return response || fetch(event.request);
                            })
                        );
                    });
                `;
                
                const blob = new Blob([serviceWorkerContent], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(reg => console.log('Service Worker registered successfully!', reg))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }
        // --------------------------------------------------------

        // ‡¶ï‡¶®‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶ü‡¶∏
        const CATEGORIES = [
            '‡¶Ö‡¶≠‡¶ø‡¶∑‡ßá‡¶ï', '‡¶™‡¶°‡¶º‡¶æ‡¶∂‡ßÅ‡¶®‡¶æ', '‡¶ó‡ßÄ‡¶§‡¶æ', '‡¶Æ‡¶æ', '‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü', '‡¶ó‡¶æ‡¶°‡¶º‡¶ø', '‡¶Æ‡ßá‡¶á‡¶®‡¶ü‡ßá‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏', '‡¶á‡¶≤‡ßá‡¶ï‡¶ü‡ßç‡¶∞‡¶ø‡¶ï', 
            '‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ', '‡¶Æ‡ßÅ‡¶¶‡¶ø‡¶ñ‡¶®‡¶æ', '‡¶∏‡¶¨‡ßç‡¶ú‡ßÄ', '‡¶´‡¶≤', '‡¶Æ‡¶æ‡¶õ ‡¶Æ‡¶æ‡¶Ç‡¶∏', '‡¶∞‡ßá‡¶∏‡ßç‡¶ü‡ßÅ‡¶∞‡ßá‡¶®‡ßç‡¶ü', '‡¶ò‡ßã‡¶∞‡¶æ', '‡¶°‡¶æ‡¶ï‡ßç‡¶§‡¶æ‡¶∞ ‡¶ì ‡¶î‡¶∑‡¶ß',
            '‡¶ú‡¶Æ‡¶æ ‡¶ï‡¶æ‡¶™‡¶°‡¶º', '‡¶Ö‡¶≠‡¶ø‡¶∑‡¶ø‡¶ï‡ßç‡¶§‡¶æ', '‡¶Ö‡¶®‡ßÅ‡¶∞‡¶ø‡¶ï‡ßç‡¶§‡¶æ', '‡¶∂‡ßç‡¶¨‡¶∂‡ßÅ‡¶∞ ‡¶¨‡¶æ‡¶°‡¶º‡¶ø', '‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø'
        ];
        const BACKGROUND_COLORS = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#E74C3C', '#2ECC71',
            '#C2185B', '#F781D8', '#82B1FF', '#C8E6C9', '#FFD54F', '#7E57C2', '#5D4037', '#00BCD4',
            '#A1887F', '#D4E157', '#64DD17', '#9E9E9E', '#78909C'
        ];

        // DOM ‡¶â‡¶™‡¶æ‡¶¶‡¶æ‡¶®
        const balanceDisplay = document.getElementById('balance-amount');
        const list = document.getElementById('transaction-list');
        const form = document.getElementById('new-transaction-form');
        const amountInput = document.getElementById('amount');
        const categoryHiddenInput = document.getElementById('category');
        const descriptionInput = document.getElementById('description'); // ‡¶®‡¶§‡ßÅ‡¶®
        const dateInput = document.getElementById('date');
        const dateFilterInput = document.getElementById('date-filter');
        const filterButtons = document.querySelectorAll('#filter-options button');
        const categorySlider = document.getElementById('category-slider');
        const exportButton = document.getElementById('export-btn');

        // ‡¶ö‡¶æ‡¶∞‡ßç‡¶ü ‡¶â‡¶™‡¶æ‡¶¶‡¶æ‡¶®
        const ctx = document.getElementById('expenseChart').getContext('2d');
        let expenseChart = null;

        // ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü‡¶∞ ‡¶â‡¶™‡¶æ‡¶¶‡¶æ‡¶®
        const calcDisplay = document.getElementById('calculator-display');
        const calcButtons = document.querySelectorAll('#calculator-buttons .calc-btn');
        let currentExpression = '0';
        let isResultDisplayed = false;

        // ‡¶°‡ßá‡¶ü‡¶æ
        dateInput.valueAsDate = new Date();
        dateFilterInput.valueAsDate = new Date();
        let transactions = JSON.parse(localStorage.getItem('transactions_bn_advanced')) || [];
        let currentView = 'day';

        // --- ‡¶á‡¶â‡¶ü‡¶ø‡¶≤‡¶ø‡¶ü‡¶ø ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ---

        function saveToLocalStorage() {
            localStorage.setItem('transactions_bn_advanced', JSON.stringify(transactions));
        }

        function generateID() {
            return Date.now(); 
        }

        // --- ‡¶ö‡¶æ‡¶∞‡ßç‡¶ü ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ---
        function updateChart(filteredTransactions) {
            const expenses = filteredTransactions.filter(t => parseFloat(t.amount) < 0);
            const expenseMap = {};

            expenses.forEach(t => {
                const category = t.category || '‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø';
                const amount = Math.abs(parseFloat(t.amount));
                expenseMap[category] = (expenseMap[category] || 0) + amount;
            });

            const labels = Object.keys(expenseMap);
            const data = Object.values(expenseMap);
            const colors = labels.map((_, index) => BACKGROUND_COLORS[index % BACKGROUND_COLORS.length]);

            document.getElementById('chart-message').innerText = '';

            if (data.length === 0) {
                document.getElementById('chart-message').innerText = '‡¶è‡¶á ‡¶∏‡¶Æ‡ßü‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶ñ‡¶∞‡¶ö ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§';
                if (expenseChart) {
                    expenseChart.destroy();
                    expenseChart = null;
                }
                return;
            }

            if (expenseChart) {
                expenseChart.data.labels = labels;
                expenseChart.data.datasets[0].data = data;
                expenseChart.data.datasets[0].backgroundColor = colors;
                expenseChart.update();
            } else {
                expenseChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            hoverBackgroundColor: colors
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'right',
                                align: 'start',
                                labels: {
                                    font: { family: 'Poppins' }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        const value = context.parsed;
                                        return label + '‚Çπ' + value.toLocaleString('en-IN');
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // --- ‡¶∏‡ßç‡¶≤‡¶æ‡¶á‡¶°‡¶ø‡¶Ç ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞‡¶ø‡¶Ç ‡¶ì ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶æ‡¶∞ ---
        function renderCategories() {
            categorySlider.innerHTML = '';
            CATEGORIES.forEach(cat => {
                const tag = document.createElement('span');
                tag.classList.add('category-tag');
                tag.textContent = cat;
                tag.dataset.category = cat;
                tag.addEventListener('click', () => selectCategory(cat));
                categorySlider.appendChild(tag);
            });
        }

        function selectCategory(category) {
            document.querySelectorAll('.category-tag').forEach(tag => tag.classList.remove('selected'));
            const selectedTag = document.querySelector(.category-tag[data-category="${category}"]);
            if (selectedTag) {
                selectedTag.classList.add('selected');
                categoryHiddenInput.value = category;
            }
        }
        
        // --- ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ---
        function handleCalculator(value) {
            if (value === 'C') { 
                currentExpression = '0';
                isResultDisplayed = false;
            } else if (value === '=') { 
                try {
                    let result = eval(currentExpression.replace('--', '+'));
                    if (isNaN(result) || !isFinite(result)) {
                        throw new Error('Invalid calculation');
                    }
                    currentExpression = result.toString();
                    amountInput.value = result.toFixed(2); 
                    isResultDisplayed = true;
                } catch (e) {
                    currentExpression = '‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø';
                    isResultDisplayed = true;
                }
            } else if (value === '+' || value === '-') {
                if (/[+\-]$/.test(currentExpression) && currentExpression.slice(-1) !== value) {
                    currentExpression = currentExpression.slice(0, -1);
                }
                currentExpression += value;
                isResultDisplayed = false;
            } else if (value === '.') {
                let parts = currentExpression.split(/[\+\-]/);
                let lastPart = parts[parts.length - 1];
                if (!lastPart.includes('.')) {
                    currentExpression += value;
                }
                isResultDisplayed = false;
            } else { 
                if (currentExpression === '0' || isResultDisplayed || currentExpression === '‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø') {
                    currentExpression = value;
                    isResultDisplayed = false;
                } else {
                    currentExpression += value;
                }
            }
            calcDisplay.innerText = currentExpression;
            if (!isResultDisplayed && currentExpression !== '0' && !currentExpression.includes('+') && !currentExpression.includes('-')) {
                 amountInput.value = parseFloat(currentExpression) || 0;
            }
        }
        
        // --- ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞‡¶ø‡¶Ç ‡¶è‡¶¨‡¶Ç ‡¶∏‡ßç‡¶≤‡¶æ‡¶á‡¶° ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶® ---
        function addTransactionDOM(transaction) {
            const amount = parseFloat(transaction.amount);
            const itemClass = amount < 0 ? 'expense' : 'income';
            const description = transaction.description || '‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ ‡¶®‡ßá‡¶á';
            
            const item = document.createElement('li');
            item.classList.add(itemClass);

            const content = document.createElement('div');
            content.classList.add('transaction-item-content');
            
            // INR ‡¶™‡ßç‡¶∞‡¶§‡ßÄ‡¶ï ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞
            const formattedAmount = Math.abs(amount).toLocaleString('en-IN', { minimumFractionDigits: 2 });
            const sign = amount < 0 ? '-' : '+';

            content.innerHTML = `
                <div class="transaction-info">
                    <div class="transaction-category">${transaction.category} <span>(${transaction.date})</span></div>
                    <div class="transaction-description">${description}</div>
                </div>
                <span class="transaction-amount">${sign} ‚Çπ${formattedAmount}</span>
            `;
            item.appendChild(content);

            const deleteBtn = document.createElement('button');
            deleteBtn.classList.add('delete-btn');
            deleteBtn.textContent = '‡¶°‡¶ø‡¶≤‡¶ø‡¶ü';
            deleteBtn.addEventListener('click', () => window.removeTransaction(transaction.id));
            item.appendChild(deleteBtn);
            
            // Swipe/Drag Logic
            let startX;
            let currentX = 0;
            const deleteThreshold = 50; 

            item.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                list.querySelectorAll('.li-swiped').forEach(el => {
                    if (el !== item) el.classList.remove('li-swiped');
                });
            });

            item.addEventListener('touchmove', (e) => {
                currentX = e.touches[0].clientX;
                let diff = currentX - startX;
                if (diff < 0) { 
                    content.style.transform = translateX(${Math.max(-70, diff)}px);
                    deleteBtn.style.transform = translateX(${Math.max(0, 70 + diff)}px);
                    e.preventDefault();
                }
            });

            item.addEventListener('touchend', () => {
                let diff = currentX - startX;
                content.style.transform = '';
                deleteBtn.style.transform = '';

                if (diff < -deleteThreshold) {
                    item.classList.add('li-swiped');
                } else {
                    item.classList.remove('li-swiped');
                }
                currentX = 0;
                startX = 0;
            });


            list.appendChild(item);
        }

        function updateBalance(filteredTransactions) {
            const amounts = filteredTransactions.map(transaction => parseFloat(transaction.amount));
            const total = amounts.reduce((acc, item) => (acc += item), 0);
            
            // INR ‡¶∏‡¶ø‡¶Æ‡ßç‡¶¨‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞
            balanceDisplay.innerText = total.toLocaleString('en-IN', { minimumFractionDigits: 2 });
            
            const balanceContainer = document.getElementById('total-balance');
            balanceContainer.style.background = total >= 0 
                ? 'linear-gradient(135deg, var(--primary-color), #FF4081)' 
                : 'linear-gradient(135deg, var(--expense-color), #FF7F7F)';
        }
        
        // --- ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞‡¶ø‡¶Ç ‡¶≤‡¶ú‡¶ø‡¶ï (‡¶Æ‡¶æ‡¶∏ ‡¶ì ‡¶¨‡¶õ‡¶∞ ‡¶´‡¶ø‡¶ï‡ßç‡¶∏) ---
        function filterTransactions() {
            const filterType = currentView;
            const filterDateStr = dateFilterInput.value;
            
            let filteredTransactions = transactions.filter(transaction => {
                // Ensure correct date comparison without timezone issues
                const transDate = new Date(transaction.date);
                const filterDate = new Date(filterDateStr);

                const transYear = transDate.getFullYear();
                const transMonth = transDate.getMonth();

                const filterYear = filterDate.getFullYear();
                const filterMonth = filterDate.getMonth();
                const filterDay = filterDate.getDate();

                if (filterType === 'day') {
                    // YYYY-MM-DD ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶§‡ßÅ‡¶≤‡¶®‡¶æ
                    return transaction.date === filterDateStr;
                } else if (filterType === 'month') {
                    // ‡¶Æ‡¶æ‡¶∏ ‡¶ì ‡¶¨‡¶õ‡¶∞ ‡¶∏‡¶Æ‡¶æ‡¶® ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá
                    return transYear === filterYear && 
                           transMonth === filterMonth;
                } else if (filterType === 'year') {
                    // ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶¨‡¶õ‡¶∞ ‡¶∏‡¶Æ‡¶æ‡¶® ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá
                    return transYear === filterYear;
                }
                return true; 
            });

            // ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶∏‡¶æ‡¶ú‡¶æ‡¶® (‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Ü‡¶ó‡ßá)
            filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));

            list.innerHTML = '';
            if (filteredTransactions.length === 0) {
                 list.innerHTML = <li style="justify-content: center; color: #999; background: #fff; border-left: none;">‡¶è‡¶á ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</li>;
            } else {
                 filteredTransactions.forEach(addTransactionDOM);
            }
            updateBalance(filteredTransactions);
            
            // ‡¶ö‡¶æ‡¶∞‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞ 
            if (currentView === 'month') {
                updateChart(filteredTransactions);
            } else {
                // ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶≠‡¶ø‡¶â‡¶§‡ßá ‡¶ö‡¶æ‡¶∞‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
                if (expenseChart) {
                    expenseChart.destroy();
                    expenseChart = null;
                }
                document.getElementById('chart-message').innerText = '‡¶ö‡¶æ‡¶∞‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶§‡ßá "‡¶Æ‡¶æ‡¶∏ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ" ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§';
            }
        }

        // --- ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶æ‡¶∞ ---
        function addTransaction(e) {
            e.preventDefault();

            const amount = parseFloat(amountInput.value);
            const category = categoryHiddenInput.value;
            const date = dateInput.value;
            const description = descriptionInput.value.trim(); // ‡¶®‡¶§‡ßÅ‡¶®

            if (isNaN(amount) || category === '' || amount === 0) {
                alert('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶¨‡ßà‡¶ß ‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶è‡¶¨‡¶Ç ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
                return;
            }

            const transaction = {
                id: generateID(),
                amount: amount.toFixed(2),
                category,
                date,
                description // ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã
            };

            transactions.push(transaction);
            saveToLocalStorage();
            
            // ‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶π‡¶≤‡ßá ‡¶¶‡¶ø‡¶® ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶≠‡¶ø‡¶â‡¶§‡ßá ‡¶Ø‡¶æ‡¶®
            dateFilterInput.value = date;
            handleFilterChange('day'); 

            // ‡¶´‡¶∞‡ßç‡¶Æ ‡¶è‡¶¨‡¶Ç ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü‡¶∞ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
            categoryHiddenInput.value = '';
            descriptionInput.value = ''; // ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü
            document.querySelectorAll('.category-tag').forEach(tag => tag.classList.remove('selected'));
            amountInput.value = '0';
            currentExpression = '0';
            calcDisplay.innerText = '0';
            dateInput.valueAsDate = new Date();
        }

        window.removeTransaction = function(id) {
            transactions = transactions.filter(transaction => transaction.id !== id);
            saveToLocalStorage();
            filterTransactions(); 
        }

        function handleFilterChange(view) {
            currentView = view;
            filterButtons.forEach(btn => btn.classList.remove('active'));
            document.getElementById(filter-${view}).classList.add('active');
            filterTransactions();
        }

        function exportData() {
            const dataStr = JSON.stringify(transactions, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'expense_data_' + new Date().toISOString().slice(0,10) + '.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            alert('‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ JSON ‡¶´‡¶æ‡¶á‡¶≤ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
        }

        // ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞‡ßç‡¶∏
        form.addEventListener('submit', addTransaction);
        exportButton.addEventListener('click', exportData);
        dateFilterInput.addEventListener('change', filterTransactions);
        filterButtons.forEach(button => {
            button.addEventListener('click', (e) => handleFilterChange(e.target.dataset.view));
        });
        calcButtons.forEach(button => {
            button.addEventListener('click', () => handleCalculator(button.dataset.value));
        });

        // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡ßü‡¶æ‡¶≤‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶®
        function init() {
            renderCategories();
            dateFilterInput.valueAsDate = new Date(); 
            // ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶≠‡¶ø‡¶â‡¶§‡ßá ‡¶Ø‡¶æ‡¶® ‡¶Ø‡¶æ‡¶§‡ßá ‡¶ö‡¶æ‡¶∞‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶Ø‡¶æ‡ßü
            handleFilterChange('month'); 
        }

        init();
    </script>
</body>
</html>